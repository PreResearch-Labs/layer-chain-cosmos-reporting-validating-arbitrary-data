package pricefeed

import (
	"bytes"
	"encoding/json"
	"fmt"
	"os"
	"testing"

	"github.com/stretchr/testify/require"
)

// ReadJsonTestFile takes a test file with human-readable, formatted JSON, load it, and compacts it.
// The purpose is to remove the formatting (e.g. newlines, tabs, etc) and return a string that would match an
// unmarshaled object string generated by a Go program natively.
func ReadJsonTestFile(t *testing.T, fileName string) string {
	fileBytes, err := os.ReadFile(fmt.Sprintf("testdata/%v", fileName))
	require.NoError(t, err, "Error reading test file")
	return CompactJsonString(t, string(fileBytes))
}

func CompactJsonString(t *testing.T, jsonString string) string {
	buffer := &bytes.Buffer{}
	err := json.Compact(buffer, []byte(jsonString))
	require.NoError(t, err, "Error compacting JSON string")
	return buffer.String()
}

// ErrorMapsEqual is a testing method that takes any two maps of keys to errors and asserts that they have the same
// sets of keys, and that each associated error value has the same rendered message.
func ErrorMapsEqual[K comparable](t *testing.T, expected map[K]error, actual map[K]error) {
	require.Equal(t, len(expected), len(actual))
	for key, expectedError := range expected {
		error, ok := actual[key]
		require.True(t, ok)
		require.EqualError(t, error, expectedError.Error())
	}
}
